name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      - name: Check scripts
        run: |
          shellcheck -x install.sh validate.sh setup.sh uninstall.sh
          shellcheck -x tools/scripts/*.sh

  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get install -y jq
      - name: Check for broken placeholders
        run: |
          # All placeholders should be {{UPPER_SNAKE}} format
          # Find any malformed ones (missing braces, wrong format)
          if grep -rn '{[A-Z_]*}' --include='*.sh' --include='*.md' --include='*.json' \
             | grep -v '{{' | grep -v '.git/' | grep -v 'CHANGELOG' | grep -v 'CONTRIBUTING'; then
            echo "ERROR: Found malformed placeholder (single braces instead of double)"
            exit 1
          fi
      - name: Check SKILL.md files parse
        run: |
          for skill in .claude/skills/*/SKILL.md; do
            if [[ ! -f "$skill" ]]; then
              echo "ERROR: Missing skill file: $skill"
              exit 1
            fi
            # Check it has content
            if [[ ! -s "$skill" ]]; then
              echo "ERROR: Empty skill file: $skill"
              exit 1
            fi
            echo "OK: $skill ($(wc -l < "$skill") lines)"
          done
      - name: Check config files have valid format
        run: |
          # command-guard.conf: non-comment lines must have " | " separator
          while IFS= read -r line; do
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            [[ -z "${line// /}" ]] && continue
            if [[ "$line" != *" | "* ]]; then
              echo "ERROR: Malformed line in command-guard.conf: $line"
              exit 1
            fi
          done < tools/config/command-guard.conf
          echo "OK: command-guard.conf"

          # secret-patterns.json: valid JSON with required schema (using jq)
          if ! jq -e '.secret_token_patterns | type == "array"' tools/config/secret-patterns.json >/dev/null 2>&1; then
            echo "ERROR: secret-patterns.json missing or invalid 'secret_token_patterns' array"
            exit 1
          fi
          PATTERN_COUNT=$(jq '.secret_token_patterns | length' tools/config/secret-patterns.json)
          # Verify each pattern has required fields
          MISSING=$(jq '[.secret_token_patterns[] | select(.name == null or .pattern == null)] | length' tools/config/secret-patterns.json)
          if [ "$MISSING" -gt 0 ]; then
            echo "ERROR: $MISSING pattern(s) missing 'name' or 'pattern' field"
            jq '.secret_token_patterns[] | select(.name == null or .pattern == null)' tools/config/secret-patterns.json
            exit 1
          fi
          echo "OK: secret-patterns.json ($PATTERN_COUNT patterns)"

  install-test:
    name: Install Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get install -y jq
      - name: Create test target
        run: |
          mkdir -p /tmp/test-repo
          cd /tmp/test-repo
          git init
          git remote add origin https://github.com/test-owner/test-repo.git
          echo "# Test" > CLAUDE.md
          mkdir -p .claude
          echo '{}' > .claude/settings.json
      - name: Test install help and structure
        run: |
          # Verify --help works
          ./install.sh --help 2>&1 | grep -q "install.sh" || { echo "ERROR: --help output missing"; exit 1; }

          # Verify uninstall --help works
          ./uninstall.sh --help 2>&1 | grep -q "uninstall" || { echo "ERROR: uninstall --help output missing"; exit 1; }

          # Verify validate --help works
          ./validate.sh --help 2>&1 | grep -q "validate" || { echo "ERROR: validate --help output missing"; exit 1; }

          echo "OK: All scripts respond to --help"

          # Verify all template files exist
          TEMPLATES=(
            "claude-md-sections.md"
            "docs/PM_PLAYBOOK.md"
            "docs/PM_PROJECT_CONFIG.md"
            "AGENTS.md"
          )
          for f in "${TEMPLATES[@]}"; do
            if [[ ! -f "$f" ]]; then
              echo "ERROR: Missing template file: $f"
              exit 1
            fi
          done
          echo "OK: All template files present"

          # Verify all scripts are executable
          NON_EXEC=$(find tools/scripts -name "*.sh" ! -executable 2>/dev/null | head -5)
          if [[ -n "$NON_EXEC" ]]; then
            echo "ERROR: Non-executable scripts found:"
            echo "$NON_EXEC"
            exit 1
          fi
          echo "OK: All scripts are executable"

          # Verify skill files exist and have content
          for skill in .claude/skills/*/SKILL.md; do
            if [[ ! -s "$skill" ]]; then
              echo "ERROR: Empty or missing skill file: $skill"
              exit 1
            fi
          done
          echo "OK: All skill files have content"
